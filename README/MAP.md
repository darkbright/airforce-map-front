# 지도

## 지도 모듈의 구성

<br>
<br>

### D2 Library

<br>
<br>

현 시스템에서 지도라고 하면 구현해야 할 상황도를 의미하며, 이 상황도는 D2(회사이름)의 라이브러리를 이용하고 있습니다. D2의 라이브러리에는 지도의 구현과 관련된 각종 함수 및 UI 등이 제이쿼리의 형태로 구성되어 있으며, `d2map.min.js`에 parcel로 압축되어 있습니다. 일반적인 상식과는 다르게, 해당 라이브러리는 `node_modules`의 형태로 제공할 수 없다는 답변을 들은 바, 파일을 통째로 넣고 구성해야 합니다.

<br>
해당 라이브러리는 용량이 매우 크기 때문에, 이를 SRC 폴더에 넣어 우리가 다시 빌드하여 재구성할 수 없습니다(React에서 경고 메시지가 옵니다). 따라서 `public/lib/d2map.min.js`에 transpile이 끝난 상태로 위치하게 됩니다.

<br>
D2 라이브러리는 전역으로서, SRC를 통해 build 되기 이전에 이미 전역함수로서 작용합니다. 크롬에서 개발자도구를 열고, Console에 다음과 같이 쳐보세요.

<br>
<br>

```
window.D2.Core
```

<br>
<br>

상기를 쳐보면 각종 Manager류 및 ol 등이 이미 구성되어 있음을 확인할 수 있습니다. 다시 이번엔 Console에서 다음과 같이 쳐보세요.

<br>
<br>

```
window.graphic
```

<br>
<br>

graphic이라고 하는 객체가 생성되어 있음을 확인할 수 있습니다. 이렇게 D2 라이브러리에서 구성된 window 전역객체들은 D2.Core와 graphic 뿐만 아니라 상당히 많은 종류의 객체들이 포함되어 있습니다.
<br>
이러한 객체 리스트는 아래의 파일에 정리를 해두었습니다. 염두해 두실 것은, D2 라이브러리는 Typescript로 작성된 것이 아니기 때문에 어떤 객체에 어떤 구성으로 되어 있는지는 알 수가 없으며, 따라서 상당 수의 객체들이 `any`의 형태로 적혀있을 수 밖에 없음을 감안하시길 바랍니다.
<br>
단, 본 문서를 작성하고 있는 개발자의 입장에서 어지럽게 나열된 객체들의 속성을 파악하는 것은 매우 중요하며, 실제로 코딩을 할 때 이것들을 모르거나 파악하지 않으면 구현에 상당한 어려움이 있기 때문에 구현과 연관이 되는 각종 객체들은 모두 정리작업을 따로 했습니다. 해당 정리는, D2가 제공하는 클래스 정의서에 나온 내용 및 개발을 하면서 실제로 파악하게 되는 특정 함수의 param 및 리턴값들을 일일이 확인하여 작업한 것입니다. 모든 내용들은 `types/d2` 내에 개별 interface 파일로 정리되어 있으니 확인하시길 바랍니다. 추후 개발에 있어 현재 시점에서 `any`로 표기되어 있으나 그 객체의 세부 property 및 method들을 파악하실 수 있다면, 다른 개발자와의 협업(혼자 일할 때에도 매우 도움이 됨)을 위하여 정리해 두시는 것을 강력하게 추천드립니다.

<br>

[src/types/d2/index.d.ts](../src/types/d2/index.d.ts)

<br>
<br>

### OpenLayers

<br>
<br>
방금 전 크롬 개발자도구 콘솔창에 `window.D2.Core`를 쳐보셨나요? 그렇다면 그 안에 `ol`이라는 객체가 포함되어 있음을 확인하실 수 있을 것입니다. `ol`은 `OpenLayers`라고 하는 자바스크립트 웹 지도 오픈소스로, 지도와 관련된 프로젝트를 해보셨다면 가장 자주 듣게 되는 대표적인 라이브러리입니다.

<br>

[OpenLayers Github Page](https://github.com/openlayers/openlayers)

<br>
<br>
D2 라이브러리는 OpenLayers(아래에서부터 ol이라고 하겠습니다)를 이용하여 기본적인 지도를 구성하고, 그 위에 각종 군대부호 및 도형, 군과 관련된 좌표의 변형, 측정 등 많은 기능들을 별도로 제작하여 제공되는 형태입니다. 다시 말해, 각종 본 프로젝트와 관련한 기능들의 근간이 되는 뼈대는 ol이라는 것입니다. 따라서 본 프로젝트를 개발 하실 때 ol에 대하여 감을 잡고 있는 것은 매우 중요합니다.

<br>
<br>
ol에 대하여는 인터넷 및 공식문서 등을 활용하여 파악하시는 것을 추천드리나, 간략하게 설명드리면 `map객체`, `layer`, `feature`의 개념이 가장 중요합니다.

<br>
<br>
1. Map 객체
<br>
<br>
최초 웹사이트가 로드가 되면서 ol은 `map`이라는 객체가 생성이 되어 있어야만 지도를 로드할 수 있습니다. map은 모든 지도와 관련된 가장 핵심이 되는 객체로 map안에 모든 중대 property가 다 들어있다고 봐도 좋을 것 같습니다. 
<br>
본 프로젝트에서는 이 map 객체의 최초 생성을 `src/libs/d2/mapSettings/setupMap.ts` 에서 합니다. 파일을 참고해보세요.

<br>
<br>
src/libs/d2/mapSettings/setupMap.ts
<br>

```ts
// 최초 맵 객체 생성
window.map = await new ol.Map({
    target: "map", // 지도 id
```

<br>
<br>
왜 window에 map을 위치시켰는가에 대해서는 논란의 여지가 있습니다. 일반적인 React 프로젝트라면 전역객체를 window에 직접 주입하는 것이 아닌 usecontext, redux나 zustand등을 활용하여 전역 context로 관리해야 하지만(실제로 ol을 활용하여 지도 모듈을 제작하는 각종 리액트 예제들을 찾아보면 context로 map 객체를 사용하고 있음을 확인하였음), D2 라이브러리와의 호환 이슈로 window에 위치시킬 수 밖에 없는 제약이 있었던 것입니다. 따라서 코딩을 하시다보면 useState와 window 객체를 두 번 관리해야 하는 경우도 있는 불편함이 있음을 확인하실 수 있습니다.

<br>
<br>
상기 코드에서 target은 html의 id값을 의미합니다. 해당 html의 id가 위치하는 곳에 map이 로드되게 되는 것입니다.

<br>
<br>
src/components/map/BaseMap.tsx
<br>

```tsx
	<div
    id="map"
    className="map"
	>
    // 각종 지도 위에 올릴 툴바 들...
    </>
```

<br>
<br>
이렇게 지도의 최초 구동과 관련된 내용은 setupMap() 함수에서 처리하고, 이를 React Component로 div에 id를 주입하여 맵을 구성하게 됩니다. 이 setupMap은 
`src/components/map/BaseMap.tsx`의 useEffect 부분을 보시길 바랍니다. 보시면 아시다시피 웹사이트를 새로고침하게 되면 웹사이트는 당연히도 다시 초기화되어 map객체 역시 처음부터 다시 로드되게 됩니다. 
<br>
<br>
따라서 map 객체가 새로고침시 마다 재구동된다는 점은, 지도 위에 그려놓은 각종 그림이나 군대부호와 같은 것들 역시 초기화된다는 것을 의미하며, 이러한 중요 자원들은 별도로 저장을 하여 불러오기를 하든지 해야만 한다는 점을 기억하시길 바랍니다.

<br>
<br>
<br>
<br>
2. Layer
<br>
<br>
맵 객체에 Layer를 넣지 않는다면 화면에는 아무것도 뜨지 않습니다. Layer란, map 객체에서 가장 중요한 개념으로 각종 지도, 각종 도형이나 그림들을 묶은 덩어리 등을 총칭하는 개념입니다.
<br>
다시 말해, 말 그대로 Layer는 포토샵에서 말하는 그러한 Layer, 즉 층을 쌓아 올리는 구조를 의미하며, 자연스럽게 가장 바닥에는 표시할 지도가 깔려야 합니다.
<br>
<br>
- 지도 Layer
<br>
<br>
어떤 지도를 로드할 것인가는 개발자가 아닌 군에서 결정할 문제입니다. 현재 기본으로 뜨는 지도는 `COP`지도라고 하는 군대에서 쓰는 지도입니다. 로드할 수 있는 지도의 종류와 구성은 군에서 제공하는 소스를 통해 D2에서 구현하여 `MapServer`라고 하는 별도의 서버를 통해서 제공되게 됩니다. 현재 가능한 것으로 추정되는 지도 리스트는 `src/data/constants/mapLayerList.ts` 파일에 정리가 되어 있습니다. 해당 파일 내 배열 내 요소를 추가하거나 삭제함으로써 전제 지도의 구성을 구현할 수 있게 됩니다.
<br>
<br>
지도 Data는 Tile이라고 하는 헤상도 및 zoom level에 따라 png 파일
